<html>
<head>
    <meta charset="utf-8"/>
    <style>
.properties {
    border-collapse:collapse;
}
.properties td, .properties th {
    border:1px solid black;
}
p {
clear:both;
}
p add {
    color:green;
}
p rem {
    color:red;
    text-decoration:line-through;
}
.code {
    white-space:pre;
    font-family:monospace;
}
    </style>
</head>
<body>
<h2>Использование транзакций.</h2>
<p>Целью этой лабораторной является знакомство с механизмом транзакций.</p>

<p>Транзакция (Transaction) — группа последовательных операций с базой данных, которая представляет собой логическую единицу работы с данными. Иными словами, это набор запросов к базе данных, который выполняется либо полностью, либо не выполняется совсем.</p>

<p>В качестве примера можно рассмотреть случай с удалением товара из базы. Если на товар был оформлен заказ, то удалять его нельзя. Иначе в базе будут заказы на несуществующие товары.</p>

<p>Чтобы узнать, в каких заказах фигурирует товар, нужно выполнить запрос SELECT. Чтобы удалить товар, нужно выполнить запрос INSERT. Эти запросы можно выполнить один за другим без дополнительного оформления и получить приемлемый результат.</p>

<p>Однако тут есть подводный камень. У системы может быть несколько пользователей. Назовем их Саша и Дима. Саша занимается оформлением заказов, а Дима отвечает за склад. Дима увидел, что в базе данных есть неиспользуемый товар и решил удалить его. В то же время, Саша начал оформлять заказ на этот товар. Дима при просмотре товаров запросами SELECT обнаружил, что на Кофе нет заказов. В то же время Саша выполнил запрос INSERT в заказы и создал заказ на Кофе, который Дима не увидит без дополнительного SELECT запроса. Дима выполняет запрос DELETE на Кофе. В результате получается заказ на несуществующий товар.</p>

<p>Чтобы избежать таких ситуаций, используются транзакции. В данном примере, при удалении товара, нужно одновременно вызвать SELECT и DELETE. Тогда Дима получит ошибку при удалении товара и заказ Саши не будет испорчен.</p>

<p>С транзакциями связаны действия:
<ul>
	<li>Начало (Begin) - отметка начала транзакции. Все последующие запросы могут быть отменены</li>
	<li>Коммит (Commit) - завершение и применение всех ее изменений от Начала</li>
	<li>Откат (Rollback) - завершение и отмена всех изменений до момента Начала</li>
</ul></p>

<p>Транзакции контролирует dao или дополнительный класс (репозиторий) между презентером и дао. В рамках лабораторной работы, транзакции будут реализованы в dao.</p>

<p>Транзакции нужно использовать при выполнении сложных INSERT, UPDATE, DELETE. Нет необходимости использовать транзакции для SELECT запросов.</p>

<p>Добавьте в ProductsDao текст запроса на получение количества заказов
<p class="code">        private static String GET_ORDERS_COUNT_CMD =
@"SELECT count(*)
FROM orders
WHERE productid = :pid";</p></p>
<p>Дополните метод delete в классе ProductsDao
<p class="code">        public bool delete(Guid id)
        {
            NpgsqlConnection connection = new NpgsqlConnection("Host=localhost;Username=business;Password=business;Database=business");
            connection.Open();
            <add>NpgsqlTransaction transaction = connection.BeginTransaction();//Создаем новую транзакцию
            //Готовим команду для получения количества заказов
            NpgsqlCommand getOrdersCmd = new NpgsqlCommand(GET_ORDERS_COUNT_CMD, connection);
            getOrdersCmd.Parameters.Add(new NpgsqlParameter(":pid", NpgsqlDbType.Uuid) { Value = id });
            //Запрос возвращает одну строчку и одну колонку, поэтому подходит такой вариант вызова
            int count = (int)getOrdersCmd.ExecuteScalar();
            if (count > 0)//Если заказы есть
            {
                transaction.Rollback();//Откатываем транзакцию
                connection.Close();//Закрываем подключение
                return false;//Сообщаем результат
            }</add>
            NpgsqlCommand cmd = new NpgsqlCommand(DELETE_CMD, connection);
            cmd.Parameters.Add(new NpgsqlParameter(":id", NpgsqlDbType.Uuid) { Value = id });
            bool result = cmd.ExecuteNonQuery() == 1;
            <add>transaction.Commit();//Коммитим транзакцию</add>
            connection.Close();
            return result;
        }
</p></p>

<p>Проверьте следующие сценарии</p>
<p>Сценарий 1
<ul>
    <li>Запустить программу.</li>
    <li>Открыть справочник товаров.</li>
    <li>Выбрать товар <i>Принцесса Гита</i>.</li>
    <li>Нажать кнопку "Удалить"</li>
	<li>Товар должен успешно удалиться</li>
</ul></p>
<p>Сценарий 6
<ul>
    <li>Запустить программу.</li>
    <li>Открыть справочник товаров.</li>
    <li>Выбрать товар <i>Принцесса Нури</i></li>
    <li>Нажать кнопку "Удалить"</li>
    <li>Должно появиться сообщение "Не удалось удалить товар"</li>
</ul></p>

<h3>Задание для самостоятельного выполнения</h3>
<p>Реализовать транзакции в случаях:
<ul>
	<li>Удаление группы товаров. Нельзя удалять группу, если есть товар.</li>
	<li>Увольнение сотрудника. Для увольнения сотрудника нужно:
		<ul>
			<li>Выставить у него hireType в "уволен"</li>
			<li>Если он начальник - назначить нового начальника</li>
			<li>Если он ответственный за заказы - переназначить открытые заказы</li>
			<li>Удалить все рабочие телефоны сотрудника</li>
		</ul>
	</li>
	<li>Изменение фамилии сотрудника. Нужно изменить фамилию всех его детей.</li>
</ul></p>
</body>
</html>